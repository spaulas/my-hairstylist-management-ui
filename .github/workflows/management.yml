name: deploy-management

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - run: npm install
      - run: npm run build

  trigger-container: 
    runs-on: ubuntu-latest
    if: env.REPOSITORY_DISPATCH == "true"
    shell: pwsh

    steps:
      - run: |
        $pat = ${{ secrets.MY_PAT }}
        $uri = "https://github.com/spaulas/my-hairstylist-container-ui"
        $base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(("{0}:{1}" -f "", $pat)))

        $headers = New-Object "System.Collections.Generic.Dictionary[[String],[String]]"
        $headers.Add("Authorization", ("Basic {0}" -f $base64AuthInfo))
        $headers.Add("Accept", "application/vnd.github.everest-preview+json")
        $headers.Add("Content-Type", "application/json")

        $body = "{
          `"event_type`": `"test-repository-dispatch`",
          `"client_payload`": {
            `"unit`": false,
            `"integration`": true
          }
        }"

        $response = Invoke-RestMethod -Uri $uri -Headers $hearders -Body $body -Method POST
        $response | ConvertTo-Json

